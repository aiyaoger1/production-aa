<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易生产下单系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f5f5f5; }
        .navbar-brand { font-weight: bold; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .order-status { font-size: 0.8rem; padding: 3px 8px; border-radius: 10px; }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-in_production { background-color: #17a2b8; color: #fff; }
        .status-completed { background-color: #28a745; color: #fff; }
        .stat-card { text-align: center; padding: 20px; }
        .stat-number { font-size: 2rem; font-weight: bold; }
        .stat-label { color: #6c757d; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-industry me-2"></i>生产下单系统
            </a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 左侧：统计和功能 -->
            <div class="col-md-3">
                <!-- 统计卡片 -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>订单统计</h5>
                    </div>
                    <div class="card-body" id="stats-container">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 创建新订单 -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>创建新订单</h5>
                    </div>
                    <div class="card-body">
                        <form id="new-order-form">
                            <div class="mb-3">
                                <label class="form-label">选择客户</label>
                                <select class="form-select" id="customer-select" required>
                                    <option value="">请选择客户...</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-link mt-1" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                                    <i class="fas fa-plus"></i> 添加新客户
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">选择产品</label>
                                <select class="form-select" id="product-select" required>
                                    <option value="">请选择产品...</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-link mt-1" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                    <i class="fas fa-plus"></i> 添加新产品
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">数量</label>
                                <input type="number" class="form-control" id="quantity" min="1" value="1" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">交货日期</label>
                                <input type="date" class="form-control" id="delivery-date">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" id="notes" rows="2"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>创建订单
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 右侧：订单列表 -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>订单列表</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="loadOrders()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="status-filter" onchange="loadOrders()">
                                <option value="">全部状态</option>
                                <option value="pending">待生产</option>
                                <option value="in_production">生产中</option>
                                <option value="completed">已完成</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="orders-container">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2">正在加载订单数据...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加客户模态框 -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新客户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-customer-form">
                        <div class="mb-3">
                            <label class="form-label">客户名称</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">联系电话</label>
                            <input type="tel" class="form-control" id="customer-contact">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">地址</label>
                            <textarea class="form-control" id="customer-address" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()">保存客户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加产品模态框 -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新产品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-product-form">
                        <div class="mb-3">
                            <label class="form-label">产品编码</label>
                            <input type="text" class="form-control" id="product-code" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">产品名称</label>
                            <input type="text" class="form-control" id="product-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">规格</label>
                            <input type="text" class="form-control" id="product-spec">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">单位</label>
                            <input type="text" class="form-control" id="product-unit" value="个">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">单价</label>
                            <input type="number" class="form-control" id="product-price" step="0.01" min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addProduct()">保存产品</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomers();
            loadProducts();
            loadOrders();
            loadStats();
        });

        // 加载客户列表
        async function loadCustomers() {
            try {
                const response = await axios.get('/api/customers');
                const select = document.getElementById('customer-select');
                select.innerHTML = '<option value="">请选择客户...</option>';
                response.data.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('加载客户失败:', error);
            }
        }

        // 加载产品列表
        async function loadProducts() {
            try {
                const response = await axios.get('/api/products');
                const select = document.getElementById('product-select');
                select.innerHTML = '<option value="">请选择产品...</option>';
                response.data.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.code} - ${product.name} (${product.spec})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('加载产品失败:', error);
            }
        }

        // 加载订单列表
        async function loadOrders() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                let url = '/api/orders';
                
                const response = await axios.get(url);
                let orders = response.data;
                
                // 过滤状态
                if (statusFilter) {
                    orders = orders.filter(order => order.status === statusFilter);
                }
                
                const container = document.getElementById('orders-container');
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">暂无订单数据</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>订单号</th>
                                    <th>客户</th>
                                    <th>产品</th>
                                    <th>数量</th>
                                    <th>下单日期</th>
                                    <th>交货日期</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orders.map(order => `
                                    <tr>
                                        <td>${order.order_number}</td>
                                        <td>${order.customer_name || '未知客户'}</td>
                                        <td>${order.product_name || '未知产品'}</td>
                                        <td>${order.quantity}</td>
                                        <td>${order.order_date}</td>
                                        <td>${order.delivery_date || '-'}</td>
                                        <td>
                                            <span class="order-status status-${order.status}">
                                                ${getStatusText(order.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="updateOrderStatus(${order.id}, 'pending')" ${order.status === 'pending' ? 'disabled' : ''}>
                                                    待产
                                                </button>
                                                <button class="btn btn-outline-info" onclick="updateOrderStatus(${order.id}, 'in_production')" ${order.status === 'in_production' ? 'disabled' : ''}>
                                                    生产
                                                </button>
                                                <button class="btn btn-outline-success" onclick="updateOrderStatus(${order.id}, 'completed')" ${order.status === 'completed' ? 'disabled' : ''}>
                                                    完成
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('加载订单失败:', error);
                document.getElementById('orders-container').innerHTML = `
                    <div class="alert alert-danger">加载订单失败，请刷新重试</div>
                `;
            }
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const response = await axios.get('/api/stats');
                const stats = response.data.stats;
                
                document.getElementById('stats-container').innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-number text-primary">${stats.total_orders}</div>
                                <div class="stat-label">总订单</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-number text-warning">${stats.pending_orders}</div>
                                <div class="stat-label">待生产</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-number text-info">${stats.production_orders}</div>
                                <div class="stat-label">生产中</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-number text-success">${stats.completed_orders}</div>
                                <div class="stat-label">已完成</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

        // 状态文本映射
        function getStatusText(status) {
            const statusMap = {
                'pending': '待生产',
                'in_production': '生产中',
                'completed': '已完成'
            };
            return statusMap[status] || status;
        }

        // 创建新订单
        document.getElementById('new-order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const orderData = {
                customer_id: document.getElementById('customer-select').value,
                product_id: document.getElementById('product-select').value,
                quantity: document.getElementById('quantity').value,
                delivery_date: document.getElementById('delivery-date').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const response = await axios.post('/api/orders', orderData);
                if (response.data.success) {
                    alert(`订单创建成功！订单号：${response.data.order_number}`);
                    // 重置表单
                    this.reset();
                    document.getElementById('quantity').value = 1;
                    // 刷新数据
                    loadOrders();
                    loadStats();
                }
            } catch (error) {
                alert('创建订单失败：' + (error.response?.data?.error || error.message));
            }
        });

        // 添加新客户
        async function addCustomer() {
            const customerData = {
                name: document.getElementById('customer-name').value,
                contact: document.getElementById('customer-contact').value,
                address: document.getElementById('customer-address').value
            };
            
            try {
                const response = await axios.post('/api/customers', customerData);
                if (response.data.success) {
                    alert('客户添加成功！');
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
                    // 重置表单
                    document.getElementById('add-customer-form').reset();
                    // 刷新客户列表
                    loadCustomers();
                }
            } catch (error) {
                alert('添加客户失败：' + (error.response?.data?.error || error.message));
            }
        }

        // 添加新产品
        async function addProduct() {
            const productData = {
                code: document.getElementById('product-code').value,
                name: document.getElementById('product-name').value,
                spec: document.getElementById('product-spec').value,
                unit: document.getElementById('product-unit').value,
                price: document.getElementById('product-price').value
            };
            
            try {
                const response = await axios.post('/api/products', productData);
                if (response.data.success) {
                    alert('产品添加成功！');
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    // 重置表单
                    document.getElementById('add-product-form').reset();
                    document.getElementById('product-unit').value = '个';
                    // 刷新产品列表
                    loadProducts();
                }
            } catch (error) {
                alert('添加产品失败：' + (error.response?.data?.error || error.message));
            }
        }

        // 更新订单状态
        async function updateOrderStatus(orderId, status) {
            if (!confirm('确定要更新订单状态吗？')) return;
            
            try {
                await axios.put(`/api/orders/${orderId}/status`, { status });
                loadOrders();
                loadStats();
            } catch (error) {
                alert('更新状态失败：' + (error.response?.data?.error || error.message));
            }
        }
    </script>
</body>
</html>
