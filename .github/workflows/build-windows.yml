name: æ„å»ºç”Ÿäº§ä¸‹å•ç³»ç»ŸEXE

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      # æ­¥éª¤1ï¼šè·å–ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤2ï¼šæ˜¾ç¤ºå½“å‰ç›®å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰
      - name: æŸ¥çœ‹æ–‡ä»¶ç»“æ„
        shell: pwsh
        run: |
          Write-Host "=== å½“å‰ç›®å½•å†…å®¹ ==="
          Get-ChildItem
          Write-Host ""
      
      # æ­¥éª¤3ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      # æ­¥éª¤4ï¼šå®‰è£…ä¾èµ–åŒ…
      - name: å®‰è£…å¿…è¦åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install flask==2.3.0
          pip install pyinstaller==5.13.0
      
      # æ­¥éª¤5ï¼šç¡®ä¿app.pyå­˜åœ¨
      - name: å‡†å¤‡ä¸»ç¨‹åºæ–‡ä»¶
        shell: pwsh
        run: |
          if (-not (Test-Path "app.py")) {
            Write-Host "åˆ›å»ºapp.pyæ–‡ä»¶..."
            @'
from flask import Flask, render_template
import os

app = Flask(__name__)

@app.route('/')
def index():
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>ç”Ÿäº§ä¸‹å•ç³»ç»Ÿ</title>
        <meta charset="utf-8">
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .header { background: #4CAF50; color: white; padding: 20px; border-radius: 10px; }
            .feature { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>âœ… ç”Ÿäº§ä¸‹å•ç³»ç»Ÿ</h1>
            <p>ç‰ˆæœ¬ 1.0 | ç‹¬ç«‹EXEç¨‹åº</p>
        </div>
        
        <h2>åŠŸèƒ½æ¨¡å—</h2>
        <div class="feature">
            <h3>ğŸ“‹ è®¢å•ç®¡ç†</h3>
            <p>åˆ›å»ºã€æŸ¥çœ‹ã€è·Ÿè¸ªç”Ÿäº§è®¢å•</p>
        </div>
        <div class="feature">
            <h3>ğŸ‘¥ å®¢æˆ·ç®¡ç†</h3>
            <p>ç®¡ç†å®¢æˆ·ä¿¡æ¯å’Œè”ç³»æ–¹å¼</p>
        </div>
        <div class="feature">
            <h3>ğŸ“¦ äº§å“ç®¡ç†</h3>
            <p>ç»´æŠ¤äº§å“ç›®å½•å’Œè§„æ ¼</p>
        </div>
        <div class="feature">
            <h3>ğŸ­ ç”Ÿäº§è·Ÿè¸ª</h3>
            <p>å®æ—¶è·Ÿè¸ªè®¢å•ç”Ÿäº§è¿›åº¦</p>
        </div>
        
        <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼Œæ— éœ€ç½‘ç»œè¿æ¥ã€‚</p>
    </body>
    </html>
    '''

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    print(f"ç”Ÿäº§ä¸‹å•ç³»ç»Ÿå¯åŠ¨... è®¿é—®åœ°å€: http://localhost:{port}")
    app.run(host='0.0.0.0', port=port, debug=False)
'@ | Out-File -FilePath "app.py" -Encoding UTF8
            Write-Host "âœ… app.py å·²åˆ›å»º"
          } else {
            Write-Host "âœ… app.py å·²å­˜åœ¨"
          }
      
      # æ­¥éª¤6ï¼šç¡®ä¿templatesæ–‡ä»¶å¤¹å­˜åœ¨
      - name: å‡†å¤‡æ¨¡æ¿æ–‡ä»¶å¤¹
        shell: pwsh
        run: |
          if (-not (Test-Path "templates")) {
            New-Item -ItemType Directory -Force -Path "templates"
            Write-Host "âœ… templatesæ–‡ä»¶å¤¹å·²åˆ›å»º"
          }
          if (-not (Test-Path "templates/index.html")) {
            @'
<!DOCTYPE html>
<html>
<head>
    <title>ç”Ÿäº§ä¸‹å•ç³»ç»Ÿ</title>
</head>
<body>
    <h1>ç”Ÿäº§ä¸‹å•ç³»ç»Ÿæ¨¡æ¿</h1>
    <p>è¿™æ˜¯æ¨¡æ¿æ–‡ä»¶ï¼Œå®é™…ä½¿ç”¨æ—¶ä¼šç”±app.pyæä¾›å®Œæ•´é¡µé¢ã€‚</p>
</body>
</html>
'@ | Out-File -FilePath "templates/index.html" -Encoding UTF8
            Write-Host "âœ… æ¨¡æ¿æ–‡ä»¶å·²åˆ›å»º"
          }
      
      # æ­¥éª¤7ï¼šæ‰“åŒ…EXEæ–‡ä»¶
      - name: ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
        run: |
          echo å¼€å§‹æ‰“åŒ…EXEæ–‡ä»¶...
          pyinstaller ^
            --onefile ^
            --name "ProductionOrderSystem" ^
            --add-data "templates;templates" ^
            --clean ^
            --noconfirm ^
            app.py
          echo æ‰“åŒ…å®Œæˆï¼
      
      # æ­¥éª¤8ï¼šéªŒè¯æ‰“åŒ…ç»“æœ
      - name: æ£€æŸ¥EXEæ–‡ä»¶
        shell: pwsh
        run: |
          $exePath = "dist/ProductionOrderSystem.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            $sizeRounded = [math]::Round($size, 2)
            Write-Host "âœ… EXEæ–‡ä»¶ç”ŸæˆæˆåŠŸï¼"
            Write-Host "æ–‡ä»¶è·¯å¾„: $exePath"
            Write-Host "æ–‡ä»¶å¤§å°: ${sizeRounded} MB"
          } else {
            Write-Error "âŒ EXEæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          }
      
      # æ­¥éª¤9ï¼šåˆ›å»ºå¯åŠ¨è„šæœ¬
      - name: åˆ›å»ºå¯åŠ¨æ–‡ä»¶
        shell: pwsh
        run: |
          @'
@echo off
chcp 65001 >nul
echo ========================================
echo     ç”Ÿäº§ä¸‹å•ç³»ç»Ÿ v1.0
echo ========================================
echo.
echo æ­£åœ¨å¯åŠ¨ç¨‹åº...
echo é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦10-30ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…...
echo.
echo å¯åŠ¨æˆåŠŸåï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
echo.
echo      http://localhost:5000
echo.
echo æŒ‰ Ctrl+C å¯åœæ­¢ç¨‹åº
echo ========================================
echo.
ProductionOrderSystem.exe
pause
'@ | Out-File -FilePath "dist/å¯åŠ¨ç³»ç»Ÿ.bat" -Encoding UTF8
          
          Write-Host "âœ… å¯åŠ¨è„šæœ¬å·²åˆ›å»º"
      
      # æ­¥éª¤10ï¼šä¸Šä¼ æ„å»ºç»“æœ
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ç”Ÿäº§ä¸‹å•ç³»ç»Ÿ-å‘å¸ƒåŒ…
          path: |
            dist/ProductionOrderSystem.exe
            dist/å¯åŠ¨ç³»ç»Ÿ.bat
          retention-days: 30
      
      # æ­¥éª¤11ï¼šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      - name: æ„å»ºå®Œæˆé€šçŸ¥
        shell: pwsh
        run: |
          $exePath = "dist/ProductionOrderSystem.exe"
          $size = (Get-Item $exePath).Length / 1MB
          $sizeRounded = [math]::Round($size, 2)
          
          @"
          ## ğŸ‰ ç”Ÿäº§ä¸‹å•ç³»ç»Ÿ EXE æ„å»ºæˆåŠŸï¼
          
          ### æ„å»ºä¿¡æ¯
          - **ç¨‹åºåç§°**: ProductionOrderSystem.exe
          - **æ–‡ä»¶å¤§å°**: ${sizeRounded} MB
          - **æ„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - **Pythonç‰ˆæœ¬**: 3.9
          - **åŒ…å«æ–‡ä»¶**: ä¸»ç¨‹åº + å¯åŠ¨è„šæœ¬
          
          ### è·å–æ–‡ä»¶
          åœ¨å³ä¾§ **Artifacts** åŒºåŸŸä¸‹è½½ï¼š
          - **ç”Ÿäº§ä¸‹å•ç³»ç»Ÿ-å‘å¸ƒåŒ….zip**
          
          ### ä½¿ç”¨æ–¹æ³•
          1. è§£å‹ä¸‹è½½çš„ZIPæ–‡ä»¶
          2. åŒå‡»è¿è¡Œ **å¯åŠ¨ç³»ç»Ÿ.bat**
          3. ç­‰å¾…ç¨‹åºå¯åŠ¨ï¼ˆé¦–æ¬¡è¿è¡Œè¾ƒæ…¢ï¼‰
          4. æ‰“å¼€æµè§ˆå™¨è®¿é—® **http://localhost:5000**
          
          ### æ³¨æ„äº‹é¡¹
          - é˜²ç«å¢™å¯èƒ½å¼¹å‡ºè­¦å‘Šï¼Œè¯·å…è®¸è®¿é—®
          - é¦–æ¬¡å¯åŠ¨éœ€è¦æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…
          - ç¨‹åºå®Œå…¨ç‹¬ç«‹ï¼Œæ— éœ€å®‰è£…Python
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY
